@page "/admin/tasting/edit/{Id:int}"

@using BlazorTest.ViewModels
@using DataAccessLibrary
@using DataAccessLibrary.Models

@inject IBeertastingRepository _db
@inject NavigationManager _nav
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<EditForm Model="@tasting">
    <DataAnnotationsValidator />
    <MudCard Elevation="2" Outlined="true">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h4">Edit tasting</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent Class="pa-4">
            <MudGrid>
                <MudItem xs="6">
                    <MudTextField Label=Name @bind-Value="tasting.Name" For="@(() => tasting.Name)"></MudTextField>
                </MudItem>
                <MudItem xs="6">
                    <MudTextField Label=Description @bind-Value="tasting.Description" For="@(() => tasting.Description)"></MudTextField>
                </MudItem>
                <MudItem xs="6">
                    <MudDatePicker Label=TastingDate @bind-Date="tasting.TastingDate" For="@(() => tasting.TastingDate)"></MudDatePicker>
                </MudItem>
                <MudItem xs="6">
                    <MudTimePicker Label=TastingTime @bind-Time="tasting.TastingTime" For="@(() => tasting.TastingTime)"></MudTimePicker>
                </MudItem>
                <MudItem xs="3">
                    <MudCheckBox Label=Active @bind-Checked="tasting.IsActive" For="@(() => tasting.IsActive)"></MudCheckBox>
                </MudItem>
                <MudItem xs="3">
                    <MudCheckBox Label=Blind @bind-Checked="tasting.IsBlind" For="@(() => tasting.IsBlind)"></MudCheckBox>
                </MudItem>
            </MudGrid>
            <MudTable Items="@tastingBeers">
                <HeaderContent>
                    <MudTh></MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Brewery</MudTh>
                    <MudTh>ABV %</MudTh>
                    <MudTh>Ratebeer</MudTh>
                    <MudTh><MudButton Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined" OnClick="@(() => AddBeer())">Add Beer</MudButton></MudTh>
                </HeaderContent>
                <RowTemplate Context="tbContext">
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Outlined.ArrowUpward" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined" OnClick="@(() => SwitchBeerSortOrder(tbContext.SortOrder, tbContext.SortOrder-1))"></MudIconButton>
                        <MudIconButton Icon="@Icons.Material.Outlined.ArrowDownward" Color="Color.Secondary" Size="Size.Small" Variant="Variant.Outlined" OnClick="@(() => SwitchBeerSortOrder(tbContext.SortOrder, tbContext.SortOrder+1))"></MudIconButton>
                    </MudTd>
                    <MudTd DataLabel="Name">@tbContext.BeerModel?.Name</MudTd>
                    <MudTd DataLabel="Brewery">@tbContext.BeerModel?.BreweryModel?.Name</MudTd>
                    <MudTd DataLabel="ABV %">@tbContext.BeerModel?.ABV</MudTd>
                    <MudTd DataLabel="Ratebeer">
                        @{
                            if (!string.IsNullOrEmpty(tbContext.BeerModel?.RateBeerLink))
                            {
                                <MudIconButton Link="@tbContext.BeerModel.RateBeerLink" Target="_blank" Icon="@Icons.Material.Outlined.Link" Color="Color.Primary" Size="Size.Small" />
                            }
                        }
                    </MudTd>
                    <MudTd><MudIconButton Icon="@Icons.Material.Outlined.Delete" Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="@(() => RemoveBeer(tbContext))" /></MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudCardContent>
        <MudCardActions>
            <MudGrid>
                <MudItem xs="12" md="12">
                    <MudContainer Class="d-flex flex-row-reverse py-2 px-1">
                        <MudButton ButtonType="ButtonType.Submit" OnClick="@EditTasting" Variant="Variant.Filled" Color="Color.Primary" Class="pa-2 mx-2">SAVE</MudButton>
                        <MudButton ButtonType="ButtonType.Button" Link="/admin/tasting" Variant="Variant.Outlined" Color="Color.Secondary" Class="pa-2 mx-2">BACK</MudButton>
                    </MudContainer>
                </MudItem>
            </MudGrid>
        </MudCardActions>
    </MudCard>
</EditForm>


@code
{
    [Parameter]
    public int Id { get; set; }

    private TastingViewModel tasting = new TastingViewModel();
    private List<TastingBeerModel> tastingBeers { get; set; } = new List<TastingBeerModel>();
    private List<BeerModel> beers { get; set; } = new List<BeerModel>();
    private List<BreweryModel> breweries { get; set; } = new List<BreweryModel>();
    private List<BeerstyleModel> beerStyles { get; set; } = new List<BeerstyleModel>();
    private List<BeerclassModel> beerClasses { get; set; } = new List<BeerclassModel>();

    protected override async Task OnInitializedAsync()
    {
        beers = await _db.GetBeers();
        breweries = await _db.GetBreweries();
        beerStyles = await _db.GetBeerstyles();
        beerClasses = await _db.GetBeerclasses();

        foreach (var beer in beers)
        {
            beer.BeerclassModel = beerClasses.SingleOrDefault(bc => bc.BeerClassId == beer.BeerClassId);
            beer.BreweryModel = breweries.SingleOrDefault(b => b.BreweryId == beer.BreweryId);
            beer.BeerStyleModel = beerStyles.SingleOrDefault(bs => bs.BeerStyleId == beer.BeerStyleId);
        }

        tasting = new TastingViewModel(await _db.GetTasting(Id));
        tastingBeers = (await _db.GetTastingBeers(Id));
        foreach (var tastingBeer in tastingBeers)
        {
            tastingBeer.BeerModel = beers.SingleOrDefault(b => b.BeerId == tastingBeer.BeerId);
        }
        tastingBeers = tastingBeers.OrderBy(tb => tb.SortOrder).ToList();
    }

    private async void EditTasting()
    {
        var editedTasting = new TastingModel()
            {
                TastingId = tasting.TastingId,
                Name = tasting.Name,
                Description = tasting.Description,
                IsActive = tasting.IsActive,
                IsBlind = tasting.IsBlind,
                TastingDate = tasting.TastingDate.GetValueOrDefault().Add(tasting.TastingTime.GetValueOrDefault())
            };

        await _db.EditTasting(editedTasting);

        _nav.NavigateTo("/admin/tasting");
    }

    private async void RemoveBeer(TastingBeerModel tastingBeer)
    {
        if (tasting.TastingDate < DateTime.Today)
        {
            var parameters = new DialogParameters();
            parameters.Add("ContentText", $"You are removing a beer from a closed tasting. Any results and votes for this tasting will be deleted for {tastingBeer.BeerModel?.Name}");
            parameters.Add("ButtonText", "CONFIRM");
            parameters.Add("Color", Color.Error);

            var dialog = DialogService.Show<DeleteDialog>("Remove beer", parameters);
            var result = await dialog.Result;

            if (result.Cancelled) return;
        }
        var tasks = new List<Task>();

        await _db.RemoveTastingResult(tastingBeer.TastingId, tastingBeer.BeerModel.BeerId);
        await _db.RemoveVotes(tastingBeer.TastingId, tastingBeer.BeerModel.BeerId);
        await _db.RemoveTastingBeer(tastingBeer);
        tastingBeers.Remove(tastingBeer);
        int i = 1;
        foreach (var otherTastingBeer in tastingBeers)
        {
            otherTastingBeer.SortOrder = i++;
            tasks.Add(_db.EditTastingBeer(otherTastingBeer));
        }
        await Task.WhenAll(tasks);
        StateHasChanged();
    }

    private async void AddBeer()
    {
        var parameters = new DialogParameters();
        parameters.Add("Beers", beers);
        parameters.Add("TastingBeers", tastingBeers);

        var dialog = DialogService.Show<AddBeerDialog>("Add Beers", parameters);
        var result = await dialog.Result;

        if (result.Cancelled) return;

        var newBeerIds = (List<int>)result.Data;
        var sortOrder = tastingBeers.Any() ? tastingBeers.Max(tb => tb.SortOrder) : 0;

        foreach (var beerId in newBeerIds)
        {
            await _db.AddTastingBeer(Id, beerId, ++sortOrder);
        }

        tastingBeers = (await _db.GetTastingBeers(Id));
        foreach (var tastingBeer in tastingBeers)
        {
            tastingBeer.BeerModel = beers.SingleOrDefault(b => b.BeerId == tastingBeer.BeerId);
        }
        tastingBeers = tastingBeers.OrderBy(tb => tb.SortOrder).ToList();
        StateHasChanged();
    }

    private async void SwitchBeerSortOrder(int sortOrder, int otherSortOrder)
    {
        var beerToSwitch = tastingBeers.SingleOrDefault(tb => tb.SortOrder == sortOrder);
        var otherBeerToSwitch = tastingBeers.SingleOrDefault(tb => tb.SortOrder == otherSortOrder);

        if (beerToSwitch is null || otherBeerToSwitch is null)
            return;

        var tmpSortOrder = beerToSwitch.SortOrder;
        beerToSwitch.SortOrder = otherBeerToSwitch.SortOrder;
        otherBeerToSwitch.SortOrder = tmpSortOrder;

        await _db.EditTastingBeer(beerToSwitch);
        await _db.EditTastingBeer(otherBeerToSwitch);

        tastingBeers = tastingBeers.OrderBy(tb => tb.SortOrder).ToList();

        StateHasChanged();
    }
}