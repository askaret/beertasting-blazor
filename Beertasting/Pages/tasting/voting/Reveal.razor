@page "/tasting/reveal/{TastingId:int}"

@using Beertasting.Util
@using DataAccessLibrary
@using DataAccessLibrary.Models
@using Beertasting.ViewModels
@using System.Globalization
@using System.ComponentModel.DataAnnotations

@inject IBeertastingRepository _db
@inject ProtectedSessionStorage ProtectedSessionStore
@inject NavigationManager _nav
@inject IDialogService DialogService

<AdminGate />

<MudText Typo="Typo.h3" Class="pa-4">Award ceremony @currentTasting?.Name</MudText>
<MudText Typo="Typo.h4" Class="pa-4">@_selectedBeerClass</MudText>
<MudText Typo="Typo.caption" Class="pa-4">Ticks: @_timerTick / Enabled: @_timer?.Enabled</MudText>
<MudPaper>
    <MudItem xs="12" md="12">
        <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
            <MudButton OnClick="@(() => RevealRegular())">Regular</MudButton>
            <MudButton OnClick="@(() => RevealHomebrew())">Homebrew</MudButton>
            <MudButton OnClick="@(() => RevealHighAbv())">High ABV</MudButton>
            <MudButton OnClick="@(() => RevealOverall())">Overall</MudButton>
        </MudButtonGroup>
    </MudItem>
</MudPaper>

<MudPaper>
    <MudGrid Class="pa-4">
        <MudItem xs="12" sm="12" Class="align-content-center">BEER CLASS RESULTS</MudItem>
        @if (_showFirstPlace)
        {
            <MudItem xs="12" sm="12" Class="align-content-center">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudAvatar Style="background-color:#FFD700">1</MudAvatar>
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.body1">1.plass </MudText>
                            <MudText Typo="Typo.caption">info info info</MudText>
                            <MudText Typo="Typo.body1">blablalblaslb</MudText>
                            <MudText Typo="Typo.caption">geewgnioweg pomwefgmop wegf</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                </MudCard>
            </MudItem>
        }
        @if (_showSecondPlace)
        {
            <MudItem xs="6" sm="6" Class="align-content-center">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudAvatar Style="background-color:#C0C0C0">2</MudAvatar>
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.body1">2.plass </MudText>
                            <MudText Typo="Typo.caption">info info info</MudText>
                            <MudText Typo="Typo.body1">blablalblaslb</MudText>
                            <MudText Typo="Typo.caption">geewgnioweg pomwefgmop wegf</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                </MudCard>
            </MudItem>
        }

        @if (_showThirdPlace)
        {
            <MudItem xs="6" sm="6" Class="align-content-center">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudAvatar Style="background-color:#b08d57  ">3</MudAvatar>
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.body1">3.plass </MudText>
                            <MudText Typo="Typo.caption">info info info</MudText>
                            <MudText Typo="Typo.body1">blablalblaslb</MudText>
                            <MudText Typo="Typo.caption">geewgnioweg pomwefgmop wegf</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
</MudPaper>

@code
{
    enum BeerClassEnum
    {
        Regular = 1,
        Homebrew = 2,
        HighAbv = 3,
        NotSelected = -1,
        All = 0
    };

    private BeerClassEnum _selectedBeerClass = BeerClassEnum.NotSelected;
    private static System.Timers.Timer _timer;

    [Parameter]
    public int TastingId { get; set; }

    [Parameter]
    public int BeerNumber { get; set; } = 0;
    private TastingModel? currentTasting = null;
    private List<TastingBeerModel>? tastingBeers = null;
    private List<TastingResultModel>? tastingResults = null;
    private List<BeerResultViewModel> beerResults = new List<BeerResultViewModel>();
    private List<BeerResultViewModel> filteredBeerResults = new List<BeerResultViewModel>();
    private List<TastingBeerModel> tastingBeerModels = new List<TastingBeerModel>();

    private bool _showFirstPlace = false;
    private bool _showSecondPlace = false;
    private bool _showThirdPlace = false;
    private int _lastBeerShown = -1;
    private int _timerTick = 0;

    private void CleanupTimerAndStates()
    {
        _timer.Enabled = false;
        _timerTick = 0;
        _selectedBeerClass = BeerClassEnum.NotSelected;

        _showThirdPlace = false;
        _showSecondPlace = false;
        _showFirstPlace = false;
        _lastBeerShown = -1;

        StateHasChanged();
    }

    private void InitializeAndStartTimer()
    {
        filteredBeerResults.Clear();
        switch (_selectedBeerClass)
        {
            case BeerClassEnum.Regular:
            case BeerClassEnum.Homebrew:
            case BeerClassEnum.HighAbv:
                filteredBeerResults.AddRange(beerResults.Where(x => x.BeerModel.BeerclassModel != null && x.BeerModel.BeerclassModel.BeerClassId == (int)_selectedBeerClass));
                break;
            case BeerClassEnum.All:
                filteredBeerResults.AddRange(beerResults);
                break;
            case BeerClassEnum.NotSelected:
                return;
        }

        _timer.Start();
        StateHasChanged();
    }

    private async Task RevealOverall()
    {
        CleanupTimerAndStates();
        _selectedBeerClass = BeerClassEnum.All;
        InitializeAndStartTimer();
    }

    private async Task RevealRegular()
    {
        CleanupTimerAndStates();
        _selectedBeerClass = BeerClassEnum.Regular;
        InitializeAndStartTimer();
    }


    private async Task RevealHomebrew()
    {
        CleanupTimerAndStates();
        _selectedBeerClass = BeerClassEnum.Homebrew;
        InitializeAndStartTimer();
    }

    private async Task RevealHighAbv()
    {
        CleanupTimerAndStates();
        _selectedBeerClass = BeerClassEnum.HighAbv;
        InitializeAndStartTimer();
    }

    private async void timerElapsed(Object source, System.Timers.ElapsedEventArgs e)
    {
        _timerTick++;

        if (_timerTick == 1)
        {
            _showThirdPlace = true;
        }
        else if (_timerTick == 2)
        {
            _showSecondPlace = true;
            _showThirdPlace = true;
        }
        else if(_timerTick >= 3)
        {
            _showFirstPlace = true;
            _showSecondPlace = true;
            _showThirdPlace = true;
        }

        //if (ShowThirdPlace && ShowSecondPlace && ShowFirstPlace)
        //{
        //    ShowThirdPlace = false;
        //    ShowSecondPlace = false;
        //    ShowFirstPlace = false;
        //}
        //else if (!ShowThirdPlace)
        //{
        //    ShowThirdPlace = true;
        //}
        //else if (!ShowSecondPlace)
        //{
        //    ShowSecondPlace = true;
        //}
        //else
        //    ShowFirstPlace = true;

        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnInitializedAsync()
    {
        _timer = new System.Timers.Timer(2000)
            {
                AutoReset = true,
                Enabled = false
            };

        _timer.Elapsed += timerElapsed;

        currentTasting = await _db.GetTasting(TastingId);

        if (currentTasting == null)
        {
            _nav.NavigateTo("/tastingNotFound");
            return;
        }

        if (currentTasting.IsActive)
        {
            var parameters = new DialogParameters();
            parameters.Add("ContentText", $"Close \"{currentTasting.Name}\" and calculate results?");
            parameters.Add("ButtonText", "Yes");
            parameters.Add("Color", Color.Warning);

            var dialog = DialogService.Show<QueryDialog>("Close and calculate?", parameters);
            var result = await dialog.Result;

            //if (result.Cancelled)
            //{
            //    _nav.NavigateTo($"/tasting/live/{TastingId}");
            //    return;
            //}

            //await CloseTasting();
        }

        await TastingUtil.CalculateTasting(_db, currentTasting);

        tastingBeerModels = await _db.GetTastingBeers(TastingId);
        tastingResults = await _db.GetTastingResults();
        beerResults = new List<BeerResultViewModel>();

        foreach (var tbm in tastingBeerModels)
        {
            beerResults.Add(new BeerResultViewModel()
                {
                    BeerModel = tbm.BeerModel,
                    TastingResults = new List<TastingResultModel>(tastingResults.Where(tr => tr.BeerId == tbm.BeerId && tr.TastingId == TastingId))
                });
        }

        beerResults = beerResults.OrderByDescending(br => br.AverageFinal).ToList();
    }

    private async Task CloseTasting()
    {
        currentTasting.IsActive = false;
        await _db.UpdateTasting(currentTasting);
    }
}